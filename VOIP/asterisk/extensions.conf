;==============================================================================
; extensions.conf - Dialplan for Elevator Conference System
;==============================================================================

[general]
static=yes
writeprotect=no
clearglobals=no

;==============================================================================
; Main Internal Context
;==============================================================================
[from-internal]

;------------------------------------------------------------------------------
; Standard extension dialing (101-104, 200, 201)
;------------------------------------------------------------------------------
; Extensions 101-104 are elevator extensions

exten => 101,1,NoOp(Calling Extension 101)
 same => n,Dial(PJSIP/101,30)
 same => n,Hangup()

exten => 102,1,NoOp(Calling Extension 102)
 same => n,Dial(PJSIP/102,30)
 same => n,Hangup()

exten => 103,1,NoOp(Calling Extension 103)
 same => n,Dial(PJSIP/103,30)
 same => n,Hangup()

exten => 104,1,NoOp(Calling Extension 104)
 same => n,Dial(PJSIP/104,30)
 same => n,Hangup()

; Admin extensions.

exten => 200,1,NoOp(Calling Extension 200)
 same => n,Dial(PJSIP/200,30)
 same => n,Hangup()

exten => 201,1,NoOp(Calling Extension 201)
 same => n,Dial(PJSIP/201,30)
 same => n,Hangup()

;------------------------------------------------------------------------------
; Conference Extension - Users dial 9876 to join as default_user
; First join starts conf; subsequent join directly
; Host (200) auto-joins as admin via external AMI monitor
;------------------------------------------------------------------------------
exten => 9876,1,NoOp(=== Joining Elevator Conference ===)
 same => n,Answer()  ; Answer for media
 same => n,Set(CALLER_EXT=${CALLERID(num)})  ; Store caller ID
 same => n,NoOp(Caller Extension is ${CALLER_EXT})
 ; add logic that if the extension calling in is 201 , then it will be added as
 ; admin profile IF there is already a conference running.
 same => n,Set(CONF_PARTIES=${CONFBRIDGE_INFO(parties,elevator_conference)})
 same => n,NoOp(Conference Parties: ${CONF_PARTIES})
 ; Check if caller is admin extension and conference exists
 same => n,GotoIf($["${CALLER_EXT}" = "201" & "${CONF_PARTIES}" != ""]?admin_join)
 ; Regular user join
 same => n,NoOp(Joining as regular user)
 same => n,ConfBridge(elevator_conference,default_bridge,default_user)  ; ConfBridge(conference_name, bridge_profile, user_profile)
 same => n,Hangup()
 ; Admin join label
 same => n(admin_join),NoOp(Joining as admin with menu)
 same => n,ConfBridge(elevator_conference,default_bridge,default_admin,elevator_admin_menu)
 same => n,Hangup()

;------------------------------------------------------------------------------
; Admin Conference Extension - Extension 9877 joins as admin
; Used when incoming cellular call needs to join conference as admin
;------------------------------------------------------------------------------
exten => 9877,1,NoOp(=== Joining Elevator Conference as Admin ===)
 same => n,Answer()  ; Answer for media
 same => n,ConfBridge(elevator_conference,default_bridge,default_admin,elevator_admin_menu)  ; Join as admin with menu
 same => n,Hangup()

; Special extension for ARI to join admin to ConfBridge
; This is called by the ARI script via the "continue" endpoint
exten => confbridge_admin_join,1,NoOp(ARI Admin Auto-Join)
 same => n,Set(CONF_NAME=${ARG1})  ; Conference name passed as argument
 same => n,GotoIf($["${CONF_NAME}" = ""]?use_default)
 same => n,Set(CONF_NAME=${CONFBRIDGE_CONFERENCE})  ; Or from channel var
 same => n(use_default),GotoIf($["${CONF_NAME}" != ""]?join)
 same => n,Set(CONF_NAME=elevator_conference)  ; Default fallback
 same => n(join),NoOp(Joining ${CONF_NAME} as admin)
 same => n,Set(USER_PROFILE=${CONFBRIDGE_USER_PROFILE})
 same => n,GotoIf($["${USER_PROFILE}" = ""]?use_default_profile)
 same => n,Goto(do_join)
 same => n(use_default_profile),Set(USER_PROFILE=default_admin)
 same => n(do_join),ConfBridge(${CONF_NAME},default_bridge,${USER_PROFILE},elevator_admin_menu)
 same => n,Hangup()

; Alternative: Dynamic version that reads conference name from channel variable
exten => _confbridge_*,1,NoOp(ARI Dynamic ConfBridge Join)
 same => n,Set(CONF_NAME=${EXTEN:11})  ; Strip "confbridge_" prefix
 same => n,Set(USER_PROFILE=${IF($["${CONFBRIDGE_USER_PROFILE}" != ""]?${CONFBRIDGE_USER_PROFILE}:default_admin)})
 same => n,NoOp(Joining conference: ${CONF_NAME} with profile: ${USER_PROFILE})
 same => n,ConfBridge(${CONF_NAME},default_bridge,${USER_PROFILE},elevator_admin_menu)
 same => n,Hangup()

;==============================================================================
; Add Callers Context - For ConfBridge Admin Menu
;==============================================================================
; Context jumped to by confbridge menu: collect a 3-digit extension and
; originate call into the elevator_conference
[addcallers]

;------------------------------------------------------------------------------
; Extension 'enter_ext' - Prompt admin to enter 3-digit extension to add
;------------------------------------------------------------------------------
; The menu calls dialplan_exec(addcallers,enter_ext,1) which lands here
exten => enter_ext,1,NoOp(=== ConfBridge Add Caller Flow ===)
 same => n,NoOp(Admin adding caller to elevator_conference)
 same => n,Answer()
 same => n,Read(TARGETEXT,hello-world,3,,3)  ; Prompt for 3 digits
 ; TARGETEXT now contains the digits entered (e.g., 101-104, 200, 201)
 same => n,NoOp(Target extension entered: ${TARGETEXT})
 same => n,Log(NOTICE,CONFBRIDGE DTMF: Admin ${CALLERID(num)} on ${CHANNEL} entered digits: ${TARGETEXT})
 ; Validate that exactly 3 digits were entered
 same => n,GotoIf($["${LEN(${TARGETEXT})}" != "3"]?bad)
 same => n,Set(TGT=${TARGETEXT})
 same => n,Set(ORIG_ENDPOINT=PJSIP/${TGT})
 same => n,NoOp(Attempting to originate ${ORIG_ENDPOINT} into elevator_conference)
 ; Originate the call: when answered, send to extension 'do_bridge' which joins the conference
 same => n,Originate(${ORIG_ENDPOINT},exten,addcallers,do_bridge,1,30)
 same => n,NoOp(Originate completed - returning admin to conference)
 same => n,Playback(confbridge-join)  ; Confirm to admin
 same => n,Goto(done)
 same => n(bad),NoOp(Invalid extension entered - must be 3 digits)
 same => n,Playback(invalid)
 same => n,Playback(please-try-again)
 same => n,Goto(done)
 same => n(done),NoOp(Dialplan exec complete - admin returns to conference)
 same => n,Return()  ; Return to conference

;------------------------------------------------------------------------------
; Extension 'do_bridge' - Join the originated callee to elevator_conference
;------------------------------------------------------------------------------
; When the originated endpoint answers, route them here to join the conference
exten => do_bridge,1,NoOp(=== Originated Callee Joining Conference ===)
 same => n,NoOp(Adding ${CALLERID(num)} to elevator_conference as regular user)
 same => n,ConfBridge(elevator_conference,default_bridge,default_user)
 same => n,Hangup()

;------------------------------------------------------------------------------
; Extension 'edit_primary_phone' - Update FIRST_NUMBER in config
;------------------------------------------------------------------------------
; Called when admin dials 01# from the conference menu
exten => edit_primary_phone,1,NoOp(=== Edit Primary Phone Number ===)
 same => n,NoOp(Admin ${CALLERID(num)} updating FIRST_NUMBER)
 same => n,Answer()
 same => n,Read(PHONE_NUM,custom/ENU/ENU00221_8k,30,,3)
 ; PHONE_NUM now contains the digits entered (1-30 digits)
 same => n,NoOp(Phone number entered: ${PHONE_NUM})
 same => n,Log(NOTICE,CONFIG UPDATE: Admin ${CALLERID(num)} entered phone: ${PHONE_NUM})
 ; Validate that at least 1 digit was entered and no more than 30
 same => n,Set(PHONE_LEN=${LEN(${PHONE_NUM})})
 same => n,GotoIf($[${PHONE_LEN} < 1 | ${PHONE_LEN} > 30]?invalid)
 ; Invoke the script to update K3_config_settings
 same => n,NoOp(Invoking edit_primary_phone.sh with number: ${PHONE_NUM})
 same => n,System(/mnt/data/edit_primary_phone.sh ${PHONE_NUM} >> /mnt/data/calls.log 2>&1)
 same => n,NoOp(Script completed with status: ${SYSTEMSTATUS})
 same => n,GotoIf($["${SYSTEMSTATUS}" = "SUCCESS"]?success:failed)
 same => n(success),NoOp(FIRST_NUMBER successfully updated)
 same => n,Playback(auth-thankyou)
 same => n,Goto(done)
 same => n(invalid),NoOp(Invalid phone number - must be 1-30 digits)
 same => n,Playback(invalid)
 same => n,Playback(please-try-again)
 same => n,Goto(done)
 same => n(failed),NoOp(Script execution failed)
 same => n,Playback(im-sorry)
 same => n,Goto(done)
 same => n(done),NoOp(Returning admin to conference)


;------------------------------------------------------------------------------
; Extension 'edit_second_phone' - Update SECOND_NUMBER in config
;------------------------------------------------------------------------------
; Called when admin dials 02# from the conference menu
exten => edit_second_phone,1,NoOp(=== Edit Second Phone Number ===)
 same => n,NoOp(Admin ${CALLERID(num)} updating SECOND_NUMBER)
 same => n,Answer()
 same => n,Read(PHONE_NUM,custom/ENU/ENU00222_8k,30,,3)
 ; PHONE_NUM now contains the digits entered (1-30 digits)
 same => n,NoOp(Phone number entered: ${PHONE_NUM})
 same => n,Log(NOTICE,CONFIG UPDATE: Admin ${CALLERID(num)} entered phone: ${PHONE_NUM})
 ; Validate that at least 1 digit was entered and no more than 30
 same => n,Set(PHONE_LEN=${LEN(${PHONE_NUM})})
 same => n,GotoIf($[${PHONE_LEN} < 1 | ${PHONE_LEN} > 30]?invalid)
 ; Invoke the script to update K3_config_settings
 same => n,NoOp(Invoking edit_second_phone.sh with number: ${PHONE_NUM})
 same => n,System(/mnt/data/edit_second_phone.sh ${PHONE_NUM} >> /mnt/data/calls.log 2>&1)
 same => n,NoOp(Script completed with status: ${SYSTEMSTATUS})
 same => n,GotoIf($["${SYSTEMSTATUS}" = "SUCCESS"]?success:failed)
 same => n(success),NoOp(SECOND_NUMBER successfully updated)
 same => n,Playback(auth-thankyou)
 same => n,Goto(done)
 same => n(invalid),NoOp(Invalid phone number - must be 1-30 digits)
 same => n,Playback(invalid)
 same => n,Playback(please-try-again)
 same => n,Goto(done)
 same => n(failed),NoOp(Script execution failed)
 same => n,Playback(im-sorry)
 same => n,Goto(done)
 same => n(done),NoOp(Returning admin to conference)
