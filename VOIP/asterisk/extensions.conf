;==============================================================================
; extensions.conf - Dialplan for Elevator Conference System
;==============================================================================

[general]
static=yes
writeprotect=no
clearglobals=no

;==============================================================================
; Main Internal Context
;==============================================================================
[from-internal]

;------------------------------------------------------------------------------
; Standard extension dialing (101-104, 200, 201)
;------------------------------------------------------------------------------
; Extensions 101-104 are elevator extensions

exten => 101,1,NoOp(Calling Extension 101)
 same => n,Dial(PJSIP/101,30)
 same => n,Hangup()

exten => 102,1,NoOp(Calling Extension 102)
 same => n,Dial(PJSIP/102,30)
 same => n,Hangup()

exten => 103,1,NoOp(Calling Extension 103)
 same => n,Dial(PJSIP/103,30)
 same => n,Hangup()

exten => 104,1,NoOp(Calling Extension 104)
 same => n,Dial(PJSIP/104,30)
 same => n,Hangup()

; Admin extensions.

exten => 200,1,NoOp(Calling Extension 200)
 same => n,Dial(PJSIP/200,30)
 same => n,Hangup()

exten => 201,1,NoOp(Calling Extension 201)
 same => n,Dial(PJSIP/201,30)
 same => n,Hangup()

;------------------------------------------------------------------------------
; Conference Extension - Users dial 9876 to join as default_user
; First join starts conf; subsequent join directly
; Host (200) auto-joins as admin via external AMI monitor
;------------------------------------------------------------------------------
exten => 9876,1,NoOp(=== Joining Elevator Conference ===)
 same => n,Answer()  ; Answer for media
 same => n,Set(CALLER_EXT=${CALLERID(num)})  ; Store caller ID
 same => n,NoOp(Caller Extension is ${CALLER_EXT})
 ; add logic that if the extension calling in is 201 , then it will be added as
 ; admin profile IF there is already a conference running.
 same => n,Set(CONF_PARTIES=${CONFBRIDGE_INFO(parties,elevator_conference)})
 same => n,NoOp(Conference Parties: ${CONF_PARTIES})
 ; Check if caller is admin extension and conference exists
 same => n,GotoIf($["${CALLER_EXT}" = "201" & "${CONF_PARTIES}" != ""]?admin_join)
 ; Regular user join
 same => n,NoOp(Joining as regular user)
 same => n,ConfBridge(elevator_conference,default_bridge,default_user)  ; ConfBridge(conference_name, bridge_profile, user_profile)
 same => n,Hangup()
 ; Admin join label
 same => n(admin_join),NoOp(Joining as admin with menu)
 same => n,ConfBridge(elevator_conference,default_bridge,default_admin,elevator_admin_menu)
 same => n,Hangup()

;------------------------------------------------------------------------------
; Admin Conference Extension - Extension 9877 joins as admin
; Used when incoming cellular call needs to join conference as admin
;------------------------------------------------------------------------------
exten => 9877,1,NoOp(=== Joining Elevator Conference as Admin ===)
 same => n,Answer()  ; Answer for media
 same => n,ConfBridge(elevator_conference,default_bridge,default_admin,elevator_admin_menu)  ; Join as admin with menu
 same => n,Hangup()

; Special extension for ARI to join admin to ConfBridge
; This is called by the ARI script via the "continue" endpoint
exten => confbridge_admin_join,1,NoOp(ARI Admin Auto-Join)
 same => n,Set(CONF_NAME=${ARG1})  ; Conference name passed as argument
 same => n,GotoIf($["${CONF_NAME}" = ""]?use_default)
 same => n,Set(CONF_NAME=${CONFBRIDGE_CONFERENCE})  ; Or from channel var
 same => n(use_default),GotoIf($["${CONF_NAME}" != ""]?join)
 same => n,Set(CONF_NAME=elevator_conference)  ; Default fallback
 same => n(join),NoOp(Joining ${CONF_NAME} as admin)
 same => n,Set(USER_PROFILE=${CONFBRIDGE_USER_PROFILE})
 same => n,GotoIf($["${USER_PROFILE}" = ""]?use_default_profile)
 same => n,Goto(do_join)
 same => n(use_default_profile),Set(USER_PROFILE=default_admin)
 same => n(do_join),ConfBridge(${CONF_NAME},default_bridge,${USER_PROFILE},elevator_admin_menu)
 same => n,Hangup()

; Alternative: Dynamic version that reads conference name from channel variable
exten => _confbridge_*,1,NoOp(ARI Dynamic ConfBridge Join)
 same => n,Set(CONF_NAME=${EXTEN:11})  ; Strip "confbridge_" prefix
 same => n,Set(USER_PROFILE=${IF($["${CONFBRIDGE_USER_PROFILE}" != ""]?${CONFBRIDGE_USER_PROFILE}:default_admin)})
 same => n,NoOp(Joining conference: ${CONF_NAME} with profile: ${USER_PROFILE})
 same => n,ConfBridge(${CONF_NAME},default_bridge,${USER_PROFILE},elevator_admin_menu)
 same => n,Hangup()

;==============================================================================
; Add Callers Context - For ConfBridge Admin Menu
;==============================================================================
; Context jumped to by confbridge menu: collect a 3-digit extension and
; originate call into the elevator_conference
[addcallers]

;------------------------------------------------------------------------------
; Extension 'enter_ext' - Prompt admin to enter 3-digit extension to add
;------------------------------------------------------------------------------
; The menu calls dialplan_exec(addcallers,enter_ext,1) which lands here
exten => enter_ext,1,NoOp(=== ConfBridge Add Caller Flow ===)
 same => n,NoOp(Admin adding caller to elevator_conference)
 same => n,Answer()
 same => n,Read(TARGETEXT,hello-world,3,,3)  ; Prompt for 3 digits
 ; TARGETEXT now contains the digits entered (e.g., 101-104, 200, 201)
 same => n,NoOp(Target extension entered: ${TARGETEXT})
 same => n,Log(NOTICE,CONFBRIDGE DTMF: Admin ${CALLERID(num)} on ${CHANNEL} entered digits: ${TARGETEXT})
 ; Validate that exactly 3 digits were entered
 same => n,GotoIf($["${LEN(${TARGETEXT})}" != "3"]?bad)
 same => n,Set(TGT=${TARGETEXT})
 same => n,Set(ORIG_ENDPOINT=PJSIP/${TGT})
 same => n,NoOp(Attempting to originate ${ORIG_ENDPOINT} into elevator_conference)
 ; Originate the call: when answered, send to extension 'do_bridge' which joins the conference
 same => n,Originate(${ORIG_ENDPOINT},exten,addcallers,do_bridge,1,30)
 same => n,NoOp(Originate completed - returning admin to conference)
 same => n,Playback(confbridge-join)  ; Confirm to admin
 same => n,Goto(done)
 same => n(bad),NoOp(Invalid extension entered - must be 3 digits)
 same => n,Playback(invalid)
 same => n,Playback(please-try-again)
 same => n,Goto(done)
 same => n(done),NoOp(Dialplan exec complete - admin returns to conference)
 same => n,Return()  ; Return to conference

;------------------------------------------------------------------------------
; Extension 'do_bridge' - Join the originated callee to elevator_conference
;------------------------------------------------------------------------------
; When the originated endpoint answers, route them here to join the conference
exten => do_bridge,1,NoOp(=== Originated Callee Joining Conference ===)
 same => n,NoOp(Adding ${CALLERID(num)} to elevator_conference as regular user)
 same => n,ConfBridge(elevator_conference,default_bridge,default_user)
 same => n,Hangup()

;------------------------------------------------------------------------------
; Extensions for editing phone numbers - call common subroutine
;------------------------------------------------------------------------------
exten => edit_primary_phone,1,Gosub(sub_edit_config,s,1(FIRST_NUMBER,custom/ENU/ENU00221_8k))

exten => edit_second_phone,1,Gosub(sub_edit_config,s,1(SECOND_NUMBER,custom/ENU/ENU00222_8k))

exten => edit_third_phone,1,Gosub(sub_edit_config,s,1(THIRD_NUMBER,custom/ENU/ENU00223_8k))

exten => edit_answer_count,1,Gosub(sub_edit_config,s,1(ANSWER_COUNT,custom/ENU/ENU00249_8k))

exten => edit_prog_pw,1,Gosub(sub_edit_config,s,1(PROGRAM_CODE,custom/ENU/ENU00259_8k))

exten => edit_cust_acct,1,Gosub(sub_edit_config,s,1(AC,custom/ENU/ENU00266_8k))

;------------------------------------------------------------------------------
; Extensions for playback - call common subroutine with variable name
;------------------------------------------------------------------------------
exten => playback_phone_1,1,Gosub(sub_playback,s,1(FIRST_NUMBER))

exten => playback_phone_2,1,Gosub(sub_playback,s,1(SECOND_NUMBER))

exten => playback_phone_3,1,Gosub(sub_playback,s,1(THIRD_NUMBER))

exten => playback_customer,1,Gosub(sub_playback,s,1(AC))

exten => playback_access_code,1,Gosub(sub_playback,s,1(PROGRAM_CODE))

exten => playback_answer_count,1,Gosub(sub_playback,s,1(ANSWER_COUNT))

;------------------------------------------------------------------------------
; Extension for restoring factory defaults
;------------------------------------------------------------------------------
exten => restore_factory_defaults,1,NoOp(=== Restore Factory Defaults ===)
 same => n,NoOp(Admin ${CALLERID(num)} restoring factory defaults)
 same => n,Answer()
 ; Read current HW_APP value from config file (strip quotes and trim whitespace)
 same => n,Set(SAVED_HW_APP=${SHELL(grep "^HW_APP=" /mnt/data/K3_config_settings | cut -d'=' -f2 | tr -d '"' | tr -d '\n' | tr -d '\r')})
 same => n,NoOp(Saved HW_APP value: ${SAVED_HW_APP})
; Validate HW_APP to avoid command injection: only allow known-safe values Pool or Elevator
 same => n,GotoIf($["${SAVED_HW_APP}" = "Pool"]?valid_hw_app)
 same => n,GotoIf($["${SAVED_HW_APP}" = "Elevator"]?valid_hw_app)
 same => n,NoOp(Invalid or unexpected HW_APP value "${SAVED_HW_APP}", returning to prevent unsafe System() usage)
 same => n,Playback(invalid)
 same => n,Return()
 same => n(valid_hw_app),Log(NOTICE,FACTORY RESTORE: Admin ${CALLERID(num)} restoring defaults, preserving HW_APP=${SAVED_HW_APP})
 ; Copy K3_config_settings.default to K3_config_settings
 same => n,System(cp /mnt/data/K3_config_settings.default /mnt/data/K3_config_settings)
 same => n,Set(COPY_STATUS=${SYSTEMSTATUS})
 same => n,NoOp(Factory defaults restored with status: ${COPY_STATUS})
 same => n,GotoIf($["${COPY_STATUS}" != "SUCCESS"]?failed)
 ; Set proper ownership and permissions for K3_config_settings file
 same => n,System(chown kuser:asterisk /mnt/data/K3_config_settings)
 same => n,Set(CHOWN_STATUS=${SYSTEMSTATUS})
 same => n,System(chmod 664 /mnt/data/K3_config_settings)
 same => n,Set(CHMOD_STATUS=${SYSTEMSTATUS})
 same => n,NoOp(Ownership and permissions set with status: ${CHOWN_STATUS}/${CHMOD_STATUS})
 same => n,GotoIf($["${CHMOD_STATUS}" != "SUCCESS"]?failed)
 ; Restore the HW_APP value if it was present
 same => n,GotoIf($["${SAVED_HW_APP}" = ""]?skip_restore)
 ; Validate SAVED_HW_APP contains only expected values
 same => n,GotoIf($["${SAVED_HW_APP}" = "Pool"]?restore_hw_app)
 same => n,GotoIf($["${SAVED_HW_APP}" = "Elevator"]?restore_hw_app)
 same => n,NoOp(Invalid HW_APP value detected: ${SAVED_HW_APP})
 same => n,Log(WARNING,SECURITY: Invalid HW_APP value from config: ${SAVED_HW_APP})
 same => n,Playback(invalid)
 same => n,Goto(skip_restore)
 same => n(restore_hw_app),System(sed -i "s/^HW_APP=.*/HW_APP=\\"${SAVED_HW_APP}\\"/" /mnt/data/K3_config_settings)
 same => n,NoOp(HW_APP restore status: ${SYSTEMSTATUS})
 same => n(skip_restore),NoOp(Factory defaults successfully restored)
 same => n,Playback(auth-thankyou)
 same => n,Return()
 same => n(failed),NoOp(Factory restore failed)
 same => n,Playback(im-sorry)
 same => n,Return()

;------------------------------------------------------------------------------
; DTMF Translation Subroutine - Pure Dialplan (no shell commands)
; Translates encoded sequences: *1=A, *2=B, *3=C, *4=D, *5=E, *6=F, *8=*, *9=#
;
; Usage: Gosub(sub_dtmf_translate,s,1(input_string))
; Returns: DTMF_TRANSLATED variable
;------------------------------------------------------------------------------
[sub_dtmf_translate]
exten => s,1,NoOp(=== DTMF Translation ===)
 same => n,Set(DTMF_INPUT=${ARG1})
 same => n,Set(DTMF_TRANSLATED=)
 same => n,Set(DTMF_POS=0)
 same => n,Set(DTMF_LEN=${LEN(${DTMF_INPUT})})
 same => n,NoOp(Translating: ${DTMF_INPUT} (length: ${DTMF_LEN}))
 same => n,GotoIf($[${DTMF_LEN} = 0]?done)
 ; Start translation loop
 same => n(loop),GotoIf($[${DTMF_POS} >= ${DTMF_LEN}]?done)
 same => n,Set(DTMF_CHAR=${DTMF_INPUT:${DTMF_POS}:1})
 ; Check if current character is *
 same => n,GotoIf($["${DTMF_CHAR}" != "*"]?regular_char)
 ; Found *, check for escape sequence
 same => n,Set(DTMF_NEXT_POS=$[${DTMF_POS} + 1])
 same => n,GotoIf($[${DTMF_NEXT_POS} >= ${DTMF_LEN}]?append_star)
 same => n,Set(DTMF_NEXT=${DTMF_INPUT:${DTMF_NEXT_POS}:1})
 ; Translate escape sequences
 same => n,GotoIf($["${DTMF_NEXT}" = "1"]?append_A)
 same => n,GotoIf($["${DTMF_NEXT}" = "2"]?append_B)
 same => n,GotoIf($["${DTMF_NEXT}" = "3"]?append_C)
 same => n,GotoIf($["${DTMF_NEXT}" = "4"]?append_D)
 same => n,GotoIf($["${DTMF_NEXT}" = "5"]?append_E)
 same => n,GotoIf($["${DTMF_NEXT}" = "6"]?append_F)
 same => n,GotoIf($["${DTMF_NEXT}" = "8"]?append_literal_star)
 same => n,GotoIf($["${DTMF_NEXT}" = "9"]?append_literal_hash)
 ; Unknown sequence, keep both characters
 same => n,Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}${DTMF_CHAR}${DTMF_NEXT})
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 ; Append translated characters
 same => n(append_A),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}A)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 same => n(append_B),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}B)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 same => n(append_C),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}C)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 same => n(append_D),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}D)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 same => n(append_E),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}E)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 same => n(append_F),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}F)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 same => n(append_literal_star),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}*)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 same => n(append_literal_hash),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}#)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 2])
 same => n,Goto(loop)
 ; Lone * at end of string
 same => n(append_star),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}*)
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 1])
 same => n,Goto(loop)
 ; Regular character (not *)
 same => n(regular_char),Set(DTMF_TRANSLATED=${DTMF_TRANSLATED}${DTMF_CHAR})
 same => n,Set(DTMF_POS=$[${DTMF_POS} + 1])
 same => n,Goto(loop)
 ; Done
 same => n(done),NoOp(Translation complete: ${DTMF_INPUT} -> ${DTMF_TRANSLATED})
 same => n,Return()

;------------------------------------------------------------------------------
; Context for common edit phone subroutine
;------------------------------------------------------------------------------
[sub_edit_config]
exten => s,1,NoOp(=== Edit Phone Number: ${ARG1} ===)
 same => n,NoOp(Admin ${CALLERID(num)} updating ${ARG1})
 same => n,Answer()
 same => n,Read(NEW_NUM,${ARG2},30,,3)
 ; NEW_NUM now contains the raw DTMF input
 same => n,NoOp(Raw DTMF input: ${NEW_NUM})
 ; Translate DTMF sequences using pure dialplan (*1=A, *2=B, etc.)
 same => n,Gosub(sub_dtmf_translate,s,1(${NEW_NUM}))
 same => n,Set(TRANSLATED=${DTMF_TRANSLATED})
 same => n,NoOp(Translated value: ${TRANSLATED})
 same => n,Log(NOTICE,CONFIG UPDATE: Admin ${CALLERID(num)} entered raw: ${NEW_NUM}, translated: ${TRANSLATED})
 ; Validate that at least 1 character was entered and no more than 30
 same => n,Set(PHONE_LEN=${LEN(${TRANSLATED})})
 ; Invoke the unified script to update K3_config_settings
 same => n,NoOp(Invoking edit_config.sh for ${ARG1} with value: ${TRANSLATED})
 same => n,System(/mnt/data/edit_config.sh ${ARG1} "${TRANSLATED}" >> /mnt/data/calls.log 2>&1)
 same => n,NoOp(Script completed with status: ${SYSTEMSTATUS})
 same => n,GotoIf($["${SYSTEMSTATUS}" = "SUCCESS"]?success:failed)
 same => n(success),NoOp(${ARG1} successfully updated)
 same => n,Playback(auth-thankyou)
 same => n,Return()
 same => n(invalid),NoOp(Invalid number - must be 1-30 digits)
 same => n,Playback(invalid)
 same => n,Playback(please-try-again)
 same => n,Return()
 same => n(failed),NoOp(Script execution failed)
 same => n,Playback(im-sorry)
 same => n,Return()

;------------------------------------------------------------------------------
; Context for common playback subroutine
;------------------------------------------------------------------------------
[sub_playback]
exten => s,1,NoOp(=== Playback Phone Number: ${ARG1} ===)
 same => n,NoOp(Admin ${CALLERID(num)} requesting ${ARG1} playback)
 same => n,Answer()
 ; Read the specified variable from config file
 same => n,Set(PHONE_NUMBER=${SHELL(grep "^${ARG1}=" /mnt/data/K3_config_settings | cut -d'=' -f2 | tr -d '"')})
 same => n,NoOp(${ARG1} read from config: ${PHONE_NUMBER})
 same => n,Log(NOTICE,PLAYBACK: Admin ${CALLERID(num)} reading ${ARG1}: ${PHONE_NUMBER})
 ; Check if we got a valid number
 same => n,GotoIf($["${PHONE_NUMBER}" = ""]?error)
 same => n,Set(NUM_LEN=${LEN(${PHONE_NUMBER})})
 same => n,GotoIf($[${NUM_LEN} < 1]?error)
 ; Use SayAlpha to play back the value (which may include digits, #, *, and A-F)
 same => n,NoOp(Playing back digits: ${PHONE_NUMBER})
 same => n,SayAlpha(${PHONE_NUMBER})
 same => n,Return()
 same => n(invalid_input),NoOp(Invalid input detected in ARG1: ${ARG1})
 same => n,Log(WARNING,SECURITY: Invalid characters in ARG1 parameter from ${CALLERID(num)}: ${ARG1})
 same => n,Playback(im-sorry)
 same => n,Return()
 same => n(error),NoOp(Failed to read ${ARG1} from config)
 same => n,Playback(im-sorry)
 same => n,Return()
