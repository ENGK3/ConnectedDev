;==============================================================================
; extensions.conf - Dialplan for Elevator Conference System
;==============================================================================

[general]
static=yes
writeprotect=no
clearglobals=no

;==============================================================================
; Main Internal Context
;==============================================================================
[from-internal]

;------------------------------------------------------------------------------
; Standard extension dialing (101-104, 200, 201)
;------------------------------------------------------------------------------
; Extensions 101-104 are elevator extensions

exten => 101,1,NoOp(Calling Extension 101)
 same => n,Dial(PJSIP/101,30)
 same => n,Hangup()

exten => 102,1,NoOp(Calling Extension 102)
 same => n,Dial(PJSIP/102,30)
 same => n,Hangup()

exten => 103,1,NoOp(Calling Extension 103)
 same => n,Dial(PJSIP/103,30)
 same => n,Hangup()

exten => 104,1,NoOp(Calling Extension 104)
 same => n,Dial(PJSIP/104,30)
 same => n,Hangup()

; Admin extensions.

exten => 200,1,NoOp(Calling Extension 200)
 same => n,Dial(PJSIP/200,30)
 same => n,Hangup()

exten => 201,1,NoOp(Calling Extension 201)
 same => n,Dial(PJSIP/201,30)
 same => n,Hangup()

;------------------------------------------------------------------------------
; Conference Extension - Users dial 9876 to join as default_user
; First join starts conf; subsequent join directly
; Host (200) auto-joins as admin via external AMI monitor
;------------------------------------------------------------------------------
exten => 9876,1,NoOp(=== Joining Elevator Conference ===)
 same => n,Answer()  ; Answer for media
 same => n,Set(CALLER_EXT=${CALLERID(num)})  ; Store caller ID
 same => n,NoOp(Caller Extension is ${CALLER_EXT})
 ; add logic that if the extension calling in is 201 , then it will be added as
 ; admin profile IF there is already a conference running.
 same => n,Set(CONF_PARTIES=${CONFBRIDGE_INFO(parties,elevator_conference)})
 same => n,NoOp(Conference Parties: ${CONF_PARTIES})
 ; Check if caller is admin extension and conference exists
 same => n,GotoIf($["${CALLER_EXT}" = "201" & "${CONF_PARTIES}" != ""]?admin_join)
 ; Regular user join
 same => n,NoOp(Joining as regular user)
 same => n,ConfBridge(elevator_conference,default_bridge,default_user)  ; ConfBridge(conference_name, bridge_profile, user_profile)
 same => n,Hangup()
 ; Admin join label
 same => n(admin_join),NoOp(Joining as admin)
 same => n,ConfBridge(elevator_conference,default_bridge,default_admin)
 same => n,Hangup()

; Special extension for ARI to join admin to ConfBridge
; This is called by the ARI script via the "continue" endpoint
exten => confbridge_admin_join,1,NoOp(ARI Admin Auto-Join)
 same => n,Set(CONF_NAME=${ARG1})  ; Conference name passed as argument
 same => n,GotoIf($["${CONF_NAME}" = ""]?use_default)
 same => n,Set(CONF_NAME=${CONFBRIDGE_CONFERENCE})  ; Or from channel var
 same => n(use_default),GotoIf($["${CONF_NAME}" != ""]?join)
 same => n,Set(CONF_NAME=elevator_conference)  ; Default fallback
 same => n(join),NoOp(Joining ${CONF_NAME} as admin)
 same => n,Set(USER_PROFILE=${CONFBRIDGE_USER_PROFILE})
 same => n,GotoIf($["${USER_PROFILE}" = ""]?use_default_profile)
 same => n,Goto(do_join)
 same => n(use_default_profile),Set(USER_PROFILE=default_admin)
 same => n(do_join),ConfBridge(${CONF_NAME},default_bridge,${USER_PROFILE})
 same => n,Hangup()

; Alternative: Dynamic version that reads conference name from channel variable
exten => _confbridge_*,1,NoOp(ARI Dynamic ConfBridge Join)
 same => n,Set(CONF_NAME=${EXTEN:11})  ; Strip "confbridge_" prefix
 same => n,Set(USER_PROFILE=${IF($["${CONFBRIDGE_USER_PROFILE}" != ""]?${CONFBRIDGE_USER_PROFILE}:default_admin)})
 same => n,NoOp(Joining conference: ${CONF_NAME} with profile: ${USER_PROFILE})
 same => n,ConfBridge(${CONF_NAME},default_bridge,${USER_PROFILE})
 same => n,Hangup()
