; CONF_ADDING/extensions.conf
; Dialplan for dialin conference and helper contexts

[general]
static=yes
writeprotect=no
clearglobals=no

[from-internal]
; Simple endpoints for 101-104 to reach their device (assumes PJSIP endpoints named 101..104)
exten => 101,1,NoOp(Calling Extension 101)
 same => n,Dial(PJSIP/101,30)
 same => n,Hangup()

exten => 102,1,NoOp(Calling Extension 102)
 same => n,Dial(PJSIP/102,30)
 same => n,Hangup()

exten => 103,1,NoOp(Calling Extension 103)
 same => n,Dial(PJSIP/103,30)
 same => n,Hangup()

exten => 104,1,NoOp(Calling Extension 104)
 same => n,Dial(PJSIP/104,30)
 same => n,Hangup()

; Extension 600: caller is placed alone into conference "dialin"
exten => 600,1,NoOp(Entering dialin conference via 600)
 same => n,Answer()
 same => n,Set(CONFBRIDGE(user_profile)=dialin_user)
 same => n,Set(CONFBRIDGE(bridge_profile)=dialin_bridge)
 same => n,Set(CONFBRIDGE(conference)=dialin)
 same => n,ConfBridge(dialin,dialin_bridge,dialin_user,dialin_menu)
 same => n,Hangup()

; Context jumped to by confbridge menu: collect a 3-digit extension and originate call into the conference
[addcallers]
; The menu calls dialplan_exec(addcallers,enter_ext,1) which lands here at extension 'enter_ext'
exten => enter_ext,1,NoOp(ConfBridge add caller flow - prompt for 3-digit extension)
 same => n,Answer()
 same => n,Read(TARGETEXT,hello-world,3,,3)
 ; TARGETEXT now contains the digits entered (e.g., 101..104 or any 3-digit)
 same => n,NoOp(Target extension entered: ${TARGETEXT})
 same => n,Log(NOTICE,CONFBRIDGE DTMF: Caller ${CALLERID(num)} on ${CHANNEL} entered digits: ${TARGETEXT})
 same => n,GotoIf($["${LEN(${TARGETEXT})}" != "3"]?bad)
 same => n,Set(TGT=${TARGETEXT})
 same => n,Set(ORIG_ENDPOINT=PJSIP/${TGT})
 same => n,NoOp(Attempting to originate ${ORIG_ENDPOINT} into ConfBridge dialin)
 ; Originate the call: when answered, send the answered channel to extension 'do_bridge' which runs ConfBridge
 same => n,Originate(${ORIG_ENDPOINT},exten,addcallers,do_bridge,1,30)
 same => n,NoOp(Originate completed - returning caller to conference)
 same => n,Playback(confbridge-join)
 same => n,Goto(done)
 same => n(bad),NoOp(Invalid extension entered)
 same => n,Playback(invalid)
 same => n,Playback(please-try-again)
 same => n,Goto(done)
 same => n(done),NoOp(Dialplan exec complete - caller returns to conference)

; When the originated callee answers, it will be routed here and placed into the conf
exten => do_bridge,1,NoOp(Originated callee will join ConfBridge now)
 same => n,ConfBridge(dialin,dialin_bridge,dialin_user)
 same => n,Hangup()
